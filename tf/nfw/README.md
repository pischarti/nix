# Network Firewall with Transit Gateway Architecture

This Terraform configuration creates a network firewall setup using AWS Network Firewall and Transit Gateway for traffic inspection and routing.

## Architecture Overview

```
                    ┌─────────────────────────────────────────────────────────────────┐
                    │                        AWS Account                              │
                    │                                                                 │
    ┌───────────────▼────────────────┐              ┌─────────────────────────────────▼────────────────┐
    │          App VPC               │              │         Inspection VPC                           │
    │     (12.101.0.0/16)            │              │        (11.3.0.0/16)                             │
    │                                │              │                                                  │
    │  ┌──────────────────────────┐  │              │  ┌──────────────────────────────────────────┐    │
    │  │   App Workload Subnet    │  │              │  │      TGW Subnet                          │    │
    │  │   (12.101.144.0/20)      │  │              │  │   (11.3.144.0/20)                        │    │
    │  │                          │  │              │  │                                          │    │
    │  │  ┌────────────────────┐  │  │              │  │  ┌────────────────────────────────────┐  │    │
    │  │  │   App Instances    │  │  │              │  │  │     TGW Attachment                 │  │    │
    │  │  │   (EC2, RDS, etc)  │  │  │              │  │  │   (Appliance Mode: Enable)         │  │    │
    │  │  └────────────────────┘  │  │              │  │  └────────────────────────────────────┘  │    │
    │  └──────────────────────────┘  │              │  └──────────────────────────────────────────┘    │
    │                                │              │                                                  │
    │  ┌──────────────────────────┐  │              │  ┌──────────────────────────────────────────┐    │
    │  │     TGW Subnet           │  │              │  │     Firewall Subnet                      │    │
    │  │   (12.101.128.0/20)      │  │              │  │    (11.3.128.0/20)                       │    │
    │  │                          │  │              │  │                                          │    │
    │  │  ┌────────────────────┐  │  │              │  │  ┌────────────────────────────────────┐  │    │
    │  │  │   TGW Attachment   │  │  │              │  │  │    AWS Network Firewall            │  │    │
    │  │  │   (Appliance Mode: │  │  │              │  │  │    - Stateless Rules               │  │    │
    │  │  │    Disable)        │  │  │              │  │  │    - Forward to SFE                │  │    │
    │  │  └────────────────────┘  │  │              │  │  └────────────────────────────────────┘  │    │
    │  └──────────────────────────┘  │              │  └──────────────────────────────────────────┘    │
    │                                │              │                                                  │
    │  ┌──────────────────────────┐  │              │  ┌──────────────────────────────────────────┐    │
    │  │ App Workload Route Table │  │              │  │    Inspection Route Table                │    │
    │  │                          │  │              │  │                                          │    │
    │  │  Routes:                 │  │              │  │  Routes:                                 │    │
    │  │  0.0.0.0/0 → TGW         │  │              │  │  0.0.0.0/0 → Network                     │    │
    │  │                          │  │              │  │          Firewall Endpoint               │    │
    │  └──────────────────────────┘  │              │  └──────────────────────────────────────────┘    │
    └───────────────┬────────────────┘              └─────────────────────────────────────────────────┘
                    │                                                      │
                    │                                                      │
                    └──────────────────────┬───────────────────────────────┘
                                           │
                                           ▼
                    ┌─────────────────────────────────────────────────────────────────┐
                    │                    Transit Gateway (TGW)                        │
                    │                                                                 │
                    │  ┌─────────────────────────────────────────────────────────┐    │
                    │  │              TGW Route Tables                           │    │
                    │  │                                                         │    │
                    │  │  ┌─────────────────────────┐  ┌─────────────────────┐   │    │
                    │  │  │   Inspection Route      │  │  Firewall Route     │   │    │
                    │  │  │   Table                 │  │  Table              │   │    │
                    │  │  │                         │  │                     │   │    │
                    │  │  │  Routes:                │  │  Associations:      │   │    │
                    │  │  │  0.0.0.0/0 →            │  │  • Inspection VPC   │   │    │
                    │  │  │     Inspection VPC      │  │    Attachment       │   │    │
                    │  │  │    Attachment           │  │  • Egress VPC       │   │    │
                    │  │  │                         │  │    Attachment       │   │    │
                    │  │  │  Associations:          │  │                     │   │    │
                    │  │  │  • App VPC Attachment   │  │  Routes:            │   │    │
                    │  │  │  • Egress VPC Attachment│  │  • App VPC CIDR →   │   │    │
                    │  │  │                         │  │    App VPC Attach   │   │    │
                    │  │  │                         │  │  • 0.0.0.0/0 →      │   │    │
                    │  │  │                         │  │    Egress VPC Attach│   │    │
                    │  │  └─────────────────────────┘  └─────────────────────┘   │    │
                    │  └─────────────────────────────────────────────────────────┘    │
                    └─────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
    ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
    │                                Egress VPC (10.2.0.0/16)                                         │
    │                                                                                                 │
    │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
    │  │                    TGW Subnet (10.2.128.0/20)                                           │    │
    │  │                                                                                         │    │
    │  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
    │  │  │                TGW Attachment                                                   │    │    │
    │  │  │                (Appliance Mode: Disable)                                        │    │    │
    │  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
    │  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                                 │
    │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
    │  │                    IGW Subnet (10.2.144.0/20)                                           │    │
    │  │                                                                                         │    │
    │  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
    │  │  │                Internet Gateway + NAT Gateway                                   │    │    │
    │  │  │                - Direct Internet Access                                         │    │    │
    │  │  │                - NAT for return traffic                                         │    │    │
    │  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
    │  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
    │                                                                                                 │
    │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
    │  │                    Route Tables                                                         │    │
    │  │                                                                                         │    │
    │  │  ┌─────────────────────────────┐  ┌─────────────────────────────────────────────┐       │    │
    │  │  │  Public Route Table         │  │  Firewall Route Table                       │       │    │
    │  │  │                             │  │                                             │       │    │
    │  │  │  Routes:                    │  │  Routes:                                    │       │    │
    │  │  │  0.0.0.0/0 → IGW            │  │  0.0.0.0/0 → NAT Gateway                    │       │    │
    │  │  │  12.0.0.0/8 → TGW           │  │  12.0.0.0/8 → TGW                           │       │    │
    │  │  └─────────────────────────────┘  └─────────────────────────────────────────────┘       │    │
    │  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
                    ┌─────────────────────────────────────────────────────────────────┐
                    │                        Internet                                 │
                    │                                                                 │
                    │                    External Traffic                             │
                    │                                                                 │
                    └─────────────────────────────────────────────────────────────────┘
```

## Traffic Flow

### Detailed Traffic Flow: EC2 → TGW → Inspection VPC

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Detailed Traffic Flow                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

Step 1: EC2 Instance generates outbound traffic
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  App VPC (12.101.0.0/16)                                                                        │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    App Workload Subnet (12.101.144.0/20)                                │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    EC2 Instance                                                 │    │    │
│  │  │              (Generates traffic to 8.8.8.8)                                     │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │ 12.101.144.5│ →  │   8.8.8.8   │    │     TCP     │    │     53      │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 2: Route Table lookup in App Workload Route Table
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  App Workload Route Table                                                                       │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                         Route Table Entries                                             │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────────┐  │    │
│  │  │   Destination       │  │   Target            │  │   Description                   │  │    │
│  │  │   0.0.0.0/0         │  │   tgw-046453...     │  │   Default route to TGW          │  │    │
│  │  │   12.101.0.0/16     │   local                │  │   Local VPC traffic             │  │    │
│  │  │   12.101.144.0/20   │   local                │  │   Local subnet traffic          │  │    │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 3: Traffic routed to TGW Subnet and TGW Attachment
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  App VPC TGW Subnet (12.101.128.0/20)                                                           │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    TGW Attachment                                                       │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                aws_ec2_transit_gateway_vpc_attachment.app_vpc                   │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │ Attachment  │    │ VPC ID      │    │ Subnet IDs  │    │ Appliance   │       │    │    │
│  │  │  │ ID: tgw-att-│    │ app-vpc-id  │    │ 12.101.128. │    │ Mode:       │       │    │    │
│  │  │  │ xxxxxx      │    │             │    │ 0/20        │    │ Disable     │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 4: Traffic enters Transit Gateway and hits Inspection Route Table
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Transit Gateway (tgw-0464531306bd201c5)                            │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Inspection Route Table                                               │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                aws_ec2_transit_gateway_route_table.inspection_route_table       │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐  │    │    │
│  │  │  │   Destination       │  │   Attachment        │  │   Description           │  │    │    │
│  │  │  │   0.0.0.0/0         │  │   tgw-att-inspect   │  │   Route to Inspection   │  │    │    │
│  │  │  │                     │  │   ion-vpc           │  │   VPC for firewall      │  │    │    │
│  │  │  │                     │  │                     │  │   inspection            │  │    │    │
│  │  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────┘  │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │    │
│  │  │  │              Route Table Association                                    │    │    │    │
│  │  │  │  • App VPC Attachment → Inspection Route Table                          │    │    │    │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘    │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 5: Traffic routed to Inspection VPC Attachment
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Inspection VPC TGW Subnet (11.3.144.0/20)                                                      │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                Inspection VPC TGW Attachment                                            │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │         aws_ec2_transit_gateway_vpc_attachment.inspection_vpc                   │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │ Attachment  │    │ VPC ID      │    │ Subnet IDs  │    │ Appliance   │       │    │    │
│  │  │  │ ID: tgw-att-│    │ inspect-vpc │    │ 11.3.144.0/ │    │ Mode:       │       │    │    │
│  │  │  │ yyyyyy      │    │ -id         │    │ 20          │    │ Enable      │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 6: Traffic routed from TGW Subnet to Network Firewall via Inspection Route Table
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Inspection VPC (11.3.0.0/16)                                                                   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │              Inspection Route Table (TGW Subnet)                                        │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    Route Table Entry                                            │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │ Destination │    │   Target    │    │   Type      │    │ Description │       │    │    │
│  │  │  │ 0.0.0.0/0   │ →  │ vpce-xxxxx  │    │ VPC         │    │ Route to    │       │    │    │
│  │  │  │             │    │             │    │ Endpoint    │    │ Firewall    │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Firewall Subnet (11.3.128.0/20)                                      │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                AWS Network Firewall                                             │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Firewall  │    │   Policy    │    │   Rule      │    │   Action    │       │    │    │
│  │  │  │   Name:     │    │   ARN:      │    │   Group:    │    │   Default:  │       │    │    │
│  │  │  │   nfw-tgw-  │    │   default-  │    │   stateless │    │   forward   │       │    │    │
│  │  │  │   firewall  │    │   policy    │    │   rules     │    │   to SFE    │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 7: Traffic returns from Network Firewall to TGW via Firewall Route Table
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              Transit Gateway (tgw-0464531306bd201c5)                            │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Firewall Route Table                                                 │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                aws_ec2_transit_gateway_route_table.firewall_route_table         │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐  │    │    │
│  │  │  │   Destination       │  │   Attachment        │  │   Description           │  │    │    │
│  │  │  │   0.0.0.0/0         │  │   tgw-att-app-vpc   │  │   Return traffic to     │  │    │    │
│  │  │  │                     │  │                     │  │   App VPC               │  │    │    │
│  │  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────┘  │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │    │
│  │  │  │              Route Table Association                                    │    │    │    │
│  │  │  │  • Inspection VPC Attachment → Firewall Route Table                     │    │    │    │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘    │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 7b: Traffic returns from Network Firewall to TGW via Firewall Route Table
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Inspection VPC (11.3.0.0/16)                                                                   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Firewall Route Table (Firewall Subnet)                               │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    Route Table Entry                                            │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │ Destination │    │   Target    │    │   Type      │    │ Description │       │    │    │
│  │  │  │ 0.0.0.0/0   │ →  │ tgw-xxxxx  │     │ Transit     │    │ Return to   │       │    │    │
│  │  │  │             │    │             │    │ Gateway     │    │ TGW         │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                            ↓
Step 8: Traffic exits to Internet
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Internet                                                     │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    External Destination (8.8.8.8)                                       │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Final Destination                                                │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │ 12.101.144.5│ →  │   8.8.8.8   │    │     TCP     │    │     53      │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

### Terraform Resource Mapping

| Step | Component | Terraform Resource |
|------|-----------|-------------------|
| 1 | EC2 Instance | Not defined in current config |
| 2 | App Workload Route Table | `aws_route_table.app_vpc_workload_route_table` |
| 3 | App VPC TGW Attachment | `aws_ec2_transit_gateway_vpc_attachment.app_vpc` |
| 4 | TGW Inspection Route Table | `aws_ec2_transit_gateway_route_table.inspection_route_table` |
| 5 | Inspection VPC TGW Attachment | `aws_ec2_transit_gateway_vpc_attachment.inspection_vpc` |
| 6 | Inspection Route Table + Network Firewall | `aws_route_table.inspection_vpc_inspection_route_table` + `aws_networkfirewall_firewall.aws_network_firewall` |
| 7a | TGW Firewall Route Table | `aws_ec2_transit_gateway_route_table.firewall_route_table` |
| 7b | Firewall Route Table Return Route | `aws_route_table.inspection_vpc_firewall_route_table` |
| 8 | Internet | External destination |

### Outbound Traffic (App VPC → Internet)
1. **App Workload Subnet** → App instances generate traffic
2. **App Workload Route Table** → Routes 0.0.0.0/0 to Transit Gateway
3. **TGW Inspection Route Table** → Routes traffic to Inspection VPC attachment
4. **Inspection VPC TGW Subnet** → Receives traffic from TGW
5. **Inspection Route Table** → Routes traffic to Network Firewall endpoint
6. **AWS Network Firewall** → Inspects and processes traffic based on rules
7a. **TGW Firewall Route Table** → Routes inspected traffic back to App VPC
7b. **Firewall Route Table** → Routes return traffic back to TGW
8. **Internet** → Final destination

### Inbound Traffic (Internet → App VPC)
1. **Internet** → External traffic originates
2. **Egress VPC** → Traffic enters through Internet Gateway
3. **TGW** → Traffic enters through inspection route table
4. **Inspection VPC** → Traffic is inspected by Network Firewall
5. **TGW** → Inspected traffic routed to App VPC
6. **App VPC** → Traffic reaches app instances

### Complete Traffic Flow with Egress VPC

**Outbound Traffic (App VPC → Internet via Egress VPC)**:
1. **App Workload Subnet** → App instances generate traffic
2. **App Workload Route Table** → Routes 0.0.0.0/0 to Transit Gateway
3. **TGW Inspection Route Table** → Routes traffic to Inspection VPC attachment
4. **Inspection VPC TGW Subnet** → Receives traffic from TGW
5. **Inspection Route Table** → Routes traffic to Network Firewall endpoint
6. **AWS Network Firewall** → Inspects and processes traffic based on rules
7. **TGW Firewall Route Table** → Routes inspected traffic to Egress VPC (0.0.0.0/0 → Egress VPC Attachment)
8. **Egress VPC TGW Subnet** → Receives traffic from TGW
9. **Egress VPC Firewall Route Table** → Routes traffic to NAT Gateway
10. **NAT Gateway** → Translates private IPs to public IPs
11. **Internet Gateway** → Routes traffic to Internet
12. **Internet** → Final destination

**Return Traffic (Internet → App VPC via Egress VPC)**:
1. **Internet** → Response traffic from external destination
2. **Internet Gateway** → Routes traffic to Egress VPC
3. **Egress VPC Public Route Table** → Routes traffic to TGW (12.0.0.0/8 → TGW)
4. **TGW Firewall Route Table** → Routes traffic to App VPC (App VPC CIDR → App VPC Attachment)
5. **App VPC TGW Subnet** → Receives return traffic from TGW
6. **App VPC** → Traffic reaches app instances

### NAT Gateway Traffic Flow Detail

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           NAT Gateway Traffic Flow Analysis                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Egress VPC (10.2.0.0/16) - NAT Gateway Processing                                              │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    TGW Subnet (10.2.128.0/20)                                           │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Traffic from TGW (Post-Firewall Inspection)                      │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │ 10.2.128.x  │ →  │   8.8.8.8   │    │     TCP     │    │     53      │       │    │    │
│  │  │  │ (Private IP)│    │             │    │             │    │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Firewall Route Table                                                 │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    Route Table Lookup                                           │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐  │    │    │
│  │  │  │   Destination       │  │   Target            │  │   Description           │  │    │    │
│  │  │  │   0.0.0.0/0         │  │   nat-xxxxxxxxx     │  │   Route to NAT Gateway  │  │    │    │
│  │  │  │   12.0.0.0/8        │  │   tgw-xxxxxxxxx     │  │   Route to TGW          │  │    │    │
│  │  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────┘  │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    IGW Subnet (10.2.144.0/20)                                           │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    NAT Gateway Processing                                       │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │    │
│  │  │  │                        NAT Translation                                  │    │    │    │
│  │  │  │                                                                         │    │    │    │
│  │  │  │  ┌─────────────────────┐                    ┌─────────────────────┐     │    │    │    │
│  │  │  │  │   BEFORE (Private)  │      NAT Gateway   │   AFTER (Public)    │     │    │    │    │
│  │  │  │  │                     │      Translation   │                     │     │    │    │    │
│  │  │  │  │  Source: 10.2.128.x │ ──────────────────▶│  Source: 54.x.x.x   │     │    │    │    │
│  │  │  │  │  Dest: 8.8.8.8      │                    │  Dest: 8.8.8.8      │     │    │    │    │
│  │  │  │  │  Protocol: TCP      │                    │  Protocol: TCP      │     │    │    │    │
│  │  │  │  │  Port: 53           │                    │  Port: 53           │     │    │    │    │
│  │  │  │  └─────────────────────┘                    └─────────────────────┘     │    │    │    │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘    │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │    │
│  │  │  │                    NAT Gateway State Table                              │    │    │    │
│  │  │  │                                                                         │    │    │    │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────┐    │    │    │    │
│  │  │  │  │  Private IP:Port  │  Public IP:Port  │  Remote IP:Port  │  State │   │    │    │    │
│  │  │  │  │  10.2.128.5:1234  │  54.x.x.x:5678   │   8.8.8.8:53     │  ESTAB │   │    │    │    │
│  │  │  │  │  10.2.128.6:2345  │  54.x.x.x:6789   │   1.1.1.1:80     │  ESTAB │   │    │    │    │
│  │  │  │  │  10.2.128.7:3456  │  54.x.x.x:7890   │   9.9.9.9:443    │  ESTAB │   │    │    │    │
│  │  │  │  └─────────────────────────────────────────────────────────────────┘    │    │    │    │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘    │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Internet Gateway                                                     │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Outbound Traffic to Internet                                     │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │ 54.x.x.x    │ →  │   8.8.8.8   │    │     TCP     │    │     53      │       │    │    │
│  │  │  │ (Public IP) │    │             │    │             │    │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Internet                                                     │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    External Destination (8.8.8.8)                                       │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Response Traffic                                                 │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │   8.8.8.8   │ →  │  54.x.x.x   │    │     TCP     │    │     53      │       │    │    │
│  │  │  │             │    │ (Public IP) │    │             │    │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼ (Return Path)
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Egress VPC - Return Traffic Processing                                                         │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Internet Gateway (Return Traffic)                                    │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Return Traffic from Internet                                     │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │   8.8.8.8   │ →  │  54.x.x.x   │    │     TCP     │    │     53      │       │    │    │
│  │  │  │             │    │ (Public IP) │    │             │    │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    NAT Gateway (Return Translation)                                     │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                        Reverse NAT Translation                                  │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │    │
│  │  │  │                        State Table Lookup                               │    │    │    │
│  │  │  │                                                                         │    │    │    │
│  │  │  │  ┌─────────────────────┐                    ┌─────────────────────┐     │    │    │    │
│  │  │  │  │   BEFORE (Public)   │    NAT Gateway     │   AFTER (Private)   │     │    │    │    │
│  │  │  │  │                     │    Translation     │                     │     │    │    │    │
│  │  │  │  │  Source: 8.8.8.8    │ ──────────────────▶│  Source: 8.8.8.8    │     │    │    │    │
│  │  │  │  │  Dest: 54.x.x.x     │                    │  Dest: 10.2.128.x   │     │    │    │    │
│  │  │  │  │  Protocol: TCP      │                    │  Protocol: TCP      │     │    │    │    │
│  │  │  │  │  Port: 53           │                    │  Port: 53           │     │    │    │    │
│  │  │  │  └─────────────────────┘                    └─────────────────────┘     │    │    │    │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘    │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Public Route Table                                                   │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    Route Table Lookup                                           │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐  │    │    │
│  │  │  │   Destination       │  │   Target            │  │   Description           │  │    │    │
│  │  │  │   0.0.0.0/0         │  │   igw-xxxxxxxxx     │  │   Route to Internet     │  │    │    │
│  │  │  │   12.0.0.0/8        │  │   tgw-xxxxxxxxx     │  │   Route to TGW          │  │    │    │
│  │  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────┘  │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    TGW Subnet (Return to TGW)                                           │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                Traffic to TGW (Return Path)                                     │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │   Protocol  │    │    Port     │       │    │    │
│  │  │  │   8.8.8.8   │ →  │ 10.2.128.x  │    │     TCP     │    │     53      │       │    │    │
│  │  │  │             │    │ (Private IP)│    │             │    │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### NAT Gateway Key Features

**Outbound Traffic Processing**:
1. **Private IP Translation**: Converts private IPs (10.2.128.x) to public IPs (54.x.x.x)
2. **State Table Creation**: Maintains mapping between private and public IP:port combinations
3. **Port Translation**: Assigns unique public ports for each connection
4. **Connection Tracking**: Monitors connection state for proper return traffic routing

**Return Traffic Processing**:
1. **State Table Lookup**: Uses NAT state table to find original private IP:port
2. **Reverse Translation**: Converts public IPs back to private IPs
3. **Connection Validation**: Ensures return traffic matches existing connections
4. **Route Back to TGW**: Routes return traffic back through Transit Gateway to App VPC

**NAT Gateway Benefits**:
- **Security**: Hides internal network topology from internet
- **Scalability**: Supports thousands of concurrent connections
- **Availability**: Highly available across multiple AZs
- **Cost Effective**: Pay-per-GB processed instead of per-hour

## 🧪 Testing Traffic Flow

### Quick Testing Scripts

The repository includes comprehensive testing scripts to validate traffic flow through the Network Firewall:

```bash
# 1. Setup environment and verify prerequisites
./setup_test.sh

# 2. Run quick connectivity tests
./quick_test.sh

# 3. Run comprehensive traffic analysis
./test_traffic.sh
```

### What the Tests Validate

**Basic Connectivity**:
- ✅ Internet access from both App and Egress instances
- ✅ HTTP/HTTPS requests through the firewall
- ✅ DNS resolution through the firewall
- ✅ Inter-VPC connectivity between App and Egress instances

**Network Firewall Inspection**:
- ✅ Traffic routing through Network Firewall endpoints
- ✅ Firewall rule processing and inspection
- ✅ Return traffic routing back through TGW

**NAT Gateway Functionality**:
- ✅ Private IP to public IP translation
- ✅ State table management for return traffic
- ✅ Outbound traffic through Internet Gateway

### Manual Testing Commands

```bash
# Get instance information
terraform output app_instance_id
terraform output egress_instance_id

# Test internet connectivity
ssh -i ~/.ssh/id_rsa ec2-user@<instance_ip> "ping 8.8.8.8"
ssh -i ~/.ssh/id_rsa ec2-user@<instance_ip> "curl http://httpbin.org/get"

# Test inter-VPC connectivity
ssh -i ~/.ssh/id_rsa ec2-user@<app_ip> "ping <egress_private_ip>"
ssh -i ~/.ssh/id_rsa ec2-user@<egress_ip> "ping <app_private_ip>"
```

For detailed testing instructions, see [TESTING.md](TESTING.md).

### Test Traffic Flow Diagrams

#### Basic Connectivity Test Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           Basic Connectivity Test Flow                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  App Instance (12.101.144.x) - Basic Internet Test                                              │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Test Commands Executed                                               │    │
│  │                                                                                         │    │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐               │    │
│  │  │    Test     │    │  Expected   │    │    Path     │    │   Result    │               │    │
│  │  │             │    │  Result     │    │             │    │             │               │    │
│  │  │ ping 8.8.8.8│ →  │  SUCCESS    │ →  │ App→TGW→FW  │ →  │ ✅ PASS     │               │    │
│  │  │ curl http   │ →  │  HTTP 200   │ →  │ →Egress→NAT │ →  │ ✅ PASS     │               │    │
│  │  │ nslookup    │ →  │  DNS Reply  │ →  │ →Internet   │ →  │ ✅ PASS     │               │    │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘               │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Egress Instance (10.2.128.x) - Basic Internet Test                                             │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Test Commands Executed                                               │    │
│  │                                                                                         │    │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐               │    │
│  │  │    Test     │    │  Expected   │    │    Path     │    │   Result    │               │    │
│  │  │             │    │  Result     │    │             │    │             │               │    │
│  │  │ ping 8.8.8.8│ →  │  SUCCESS    │ →  │ Egress→NAT  │ →  │ ✅ PASS     │               │    │
│  │  │ curl http   │ →  │  HTTP 200   │ →  │ →Internet   │ →  │ ✅ PASS     │               │    │
│  │  │ nslookup    │ →  │  DNS Reply  │ →  │             │ →  │ ✅ PASS     │               │    │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘               │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### Inter-VPC Connectivity Test Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        Inter-VPC Connectivity Test Flow                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Test Scenario: App Instance → Egress Instance                                                  │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  App Instance (12.101.144.x)                                                            │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Command: ping -c 3 10.2.128.x (Egress Private IP)                              │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ 12.101.144.x│ →  │ 10.2.128.x  │ →  │ App→TGW→FW  │ →  │ ✅ SUCCESS  │       │    │    │
│  │  │  │             │    │             │ →  │ →Egress     │ →  │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Test Scenario: Egress Instance → App Instance                                                  │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  Egress Instance (10.2.128.x)                                                           │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Command: ping -c 3 12.101.144.x (App Private IP)                               │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ 10.2.128.x  │ →  │ 12.101.144.x│ →  │ Egress→TGW  │ →  │ ✅ SUCCESS  │       │    │    │
│  │  │  │             │    │             │ →  │ →FW→App     │ →  │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### Network Firewall Inspection Test Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        Network Firewall Inspection Test Flow                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Protocol Testing Through Network Firewall                                                      │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  HTTP Test (Port 80)                                                                    │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Command: curl -s -o /dev/null -w '%{http_code}' http://httpbin.org/get         │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ App Instance│ →  │ httpbin.org │ →  │ App→TGW→FW  │ →  │ ✅ HTTP 200 │       │    │    │
│  │  │  │             │    │    :80      │ →  │ →Egress→NAT │ →  │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  HTTPS Test (Port 443)                                                                  │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Command: curl -s -o /dev/null -w '%{http_code}' https://httpbin.org/get        │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ App Instance│ →  │ httpbin.org │ →  │ App→TGW→FW  │ →  │ ✅ HTTP 200 │       │    │    │
│  │  │  │             │    │    :443     │ →  │ →Egress→NAT │ →  │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  DNS Test (Port 53)                                                                     │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Command: dig google.com                                                        │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ App Instance│ →  │ 8.8.8.8:53  │ →  │ App→TGW→FW  │ →  │ ✅ DNS Reply│       │    │    │
│  │  │  │             │    │             │ →  │ →Egress→NAT │ →  │             │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### NAT Gateway Test Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              NAT Gateway Test Flow                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Test Scenario: Verify NAT Translation from Egress Instance                                     │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  Egress Instance (10.2.128.x) - Private IP                                              │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Test 1: Check Public IP Seen by External Service                               │    │    │
│  │  │                                                                                 │    │    │
│  │  │  Command: curl -s http://httpbin.org/ip                                         │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ 10.2.128.x  │ →  │ httpbin.org │ →  │ Egress→NAT  │ →  │ 54.x.x.x    │       │    │    │
│  │  │  │ (Private)   │    │             │ →  │ →Internet   │ →  │ (Public)    │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Test 2: Compare with Instance's Actual Public IP                               │    │    │
│  │  │                                                                                 │    │    │
│  │  │  Command: curl -s ifconfig.me                                                   │    │    │
│  │  │                                                                                 │    │    │
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │    │
│  │  │  │   Source    │    │ Destination │    │    Path     │    │   Result    │       │    │    │
│  │  │  │ 10.2.128.x  │ →  │ ifconfig.me │ →  │ Egress→NAT  │ →  │ 54.x.x.x    │       │    │    │
│  │  │  │ (Private)   │    │             │ →  │ →Internet   │ →  │ (Public)    │       │    │    │
│  │  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘       │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                                         │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │  Expected Result: Both commands return same public IP (NAT Gateway IP)          │    │    │
│  │  │  ✅ NAT Gateway is working correctly                                            │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### Comprehensive Test Flow Summary

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        Comprehensive Test Flow Summary                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Test Execution Order and Results                                                               │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  1. Setup and Prerequisites Check                                                       │    │
│  │     ✅ AWS CLI configured                                                               │    │
│  │     ✅ Terraform applied                                                                │    │
│  │     ✅ Instances running                                                                │    │
│  │     ✅ SSH connectivity verified                                                        │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  2. Basic Connectivity Tests                                                            │    │
│  │     ✅ App Instance → Internet (ping, HTTP, DNS)                                        │    │
│  │     ✅ Egress Instance → Internet (ping, HTTP, DNS)                                     │    │
│  │     ✅ Inter-VPC connectivity (App ↔ Egress)                                            │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  3. Network Firewall Inspection Tests                                                   │    │
│  │     ✅ HTTP traffic inspection                                                          │    │
│  │     ✅ HTTPS traffic inspection                                                         │    │
│  │     ✅ DNS traffic inspection                                                           │    │
│  │     ✅ SSH traffic inspection                                                           │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  4. NAT Gateway Functionality Tests                                                     │    │
│  │     ✅ Private IP to Public IP translation                                              │    │
│  │     ✅ State table management                                                           │    │
│  │     ✅ Return traffic routing                                                           │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                                     │
│                                           ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  5. Final Results                                                                       │    │
│  │     ✅ All tests passed                                                                 │    │
│  │     ✅ Network Firewall architecture validated                                          │    │
│  │     ✅ Traffic flow working as expected                                                 │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## ✅ Configuration Status

**Complete Architecture**: The configuration now includes all necessary routes for a fully functional network firewall setup:

```hcl
# ✅ Complete: Route from Firewall Route Table back to TGW
resource "aws_route" "inspection_vpc_firewall_route_nat_gateway" {
  destination_cidr_block = "0.0.0.0/0"
  transit_gateway_id     = aws_ec2_transit_gateway.tgw.id
  route_table_id         = aws_route_table.inspection_vpc_firewall_route_table.id
}

# ✅ Complete: Route for App VPC return traffic
resource "aws_ec2_transit_gateway_route" "app_vpc" {
  destination_cidr_block         = var.app_vpc_cidr
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.app_vpc.id
  transit_gateway_route_table_id = aws_ec2_transit_gateway_route_table.firewall_route_table.id
}
```

## ✅ Complete Egress VPC Architecture

**Egress VPC**: The Egress VPC is now fully implemented to provide internet connectivity:

```hcl
# ✅ Complete: Egress VPC for internet connectivity
module "egress_vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "v6.0.1"
  name    = "${local.name}-egress-vpc"
  cidr    = var.egress_vpc_cidr  # 10.2.0.0/16
}

# ✅ Complete: TGW VPC Attachment for Egress VPC
resource "aws_ec2_transit_gateway_vpc_attachment" "egress_vpc" {
  subnet_ids = [aws_subnet.egress_vpc_tgw_subnet.id]
  transit_gateway_id = aws_ec2_transit_gateway.tgw.id
  vpc_id = module.egress_vpc.vpc_id
}
```

**Implemented Egress VPC Components**:
- ✅ TGW Subnet (10.2.128.0/20)
- ✅ IGW Subnet (10.2.144.0/20) 
- ✅ Internet Gateway + NAT Gateway
- ✅ TGW VPC Attachment
- ✅ Route tables for internet connectivity
- ✅ TGW Route Table Association
- ✅ TGW Routes for internet traffic

## Key Components

### App VPC (12.101.0.0/16)
- **App Workload Subnet** (12.101.144.0/20): Hosts application instances
- **TGW Subnet** (12.101.128.0/20): Connects to Transit Gateway
- **App Workload Route Table**: Routes all traffic (0.0.0.0/0) to TGW

### Inspection VPC (11.3.0.0/16)
- **TGW Subnet** (11.3.144.0/20): Transit Gateway attachment point
- **Firewall Subnet** (11.3.128.0/20): AWS Network Firewall deployment
- **AWS Network Firewall**: Stateless rules, forwards to SFE by default
- **Inspection Route Table**: Routes traffic from TGW to Network Firewall endpoint
- **Firewall Route Table**: Routes inspected traffic back to TGW

### Transit Gateway
- **Inspection Route Table**: Routes App VPC traffic to Inspection VPC
- **Firewall Route Table**: Routes inspected traffic back to App VPC with specific App VPC CIDR route
- **Appliance Mode**: Enabled for Inspection VPC, Disabled for App VPC

### Egress VPC (10.2.0.0/16) - ✅ Complete
- **TGW Subnet** (10.2.128.0/20): Transit Gateway attachment point
- **IGW Subnet** (10.2.144.0/20): Internet Gateway subnet with NAT Gateway for internet connectivity
- **Internet Gateway**: Direct internet access for outbound traffic
- **NAT Gateway**: Handles return traffic from internet
- **TGW VPC Attachment**: Connected to Transit Gateway (Appliance Mode: Disable)
- **Public Route Table**: Routes internet traffic (0.0.0.0/0 → IGW) and App VPC traffic (12.0.0.0/8 → TGW)
- **Firewall Route Table**: Routes to NAT Gateway (0.0.0.0/0) and App VPC traffic (12.0.0.0/8 → TGW)

## Terraform Resources

### VPC and Networking
- `module.app_vpc` - App VPC using terraform-aws-modules/vpc
- `module.inspection_vpc` - Inspection VPC using terraform-aws-modules/vpc
- `module.egress_vpc` - Egress VPC using terraform-aws-modules/vpc
- Subnets for workload, TGW, firewall, and internet connectivity
- Internet Gateway and NAT Gateway for egress VPC

### Transit Gateway
- `aws_ec2_transit_gateway.tgw` - Main Transit Gateway
- `aws_ec2_transit_gateway_route_table` - Route tables for traffic direction
- `aws_ec2_transit_gateway_vpc_attachment` - VPC attachments (App, Inspection, Egress)
- `aws_ec2_transit_gateway_route_table_association` - Route table associations
- `aws_ec2_transit_gateway_route.inspection_vpc` - Route to Inspection VPC
- `aws_ec2_transit_gateway_route.app_vpc` - Route for App VPC return traffic
- `aws_ec2_transit_gateway_route.egress_vpc_to_internet` - Route for internet traffic via Egress VPC

### Network Firewall
- `aws_networkfirewall_firewall` - AWS Network Firewall instance
- `aws_networkfirewall_firewall_policy` - Firewall policy configuration
- `aws_networkfirewall_rule_group` - Stateless rule group (forward to SFE)

### Routing
- `aws_route_table` - VPC route tables
- `aws_route` - Routes directing traffic through TGW
- `aws_route_table_association` - Subnet to route table associations

## Configuration

Update `env.tfvars` with your specific values:
- `aws_region` - AWS region for deployment
- `team` - Team identifier
- `env` - Environment name
- CIDR blocks for VPCs and subnets

## Deployment

```bash
terraform init
terraform plan -var-file=env.tfvars
terraform apply -var-file=env.tfvars
```
